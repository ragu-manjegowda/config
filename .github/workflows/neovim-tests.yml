name: Neovim Configuration Tests

on:
  push:
    branches: [main, master, develop]
    paths:
      - ".config/nvim/**"
      - ".github/workflows/neovim-tests.yml"
  pull_request:
    branches: [main, master, develop]
    paths:
      - ".config/nvim/**"
      - ".github/workflows/neovim-tests.yml"
  workflow_dispatch:

jobs:
  # ============================================================================
  # SETUP - Runs once, discovers tests, creates artifact for all test jobs
  # ============================================================================
  # To exclude tests, create .config/nvim/tests/.testignore with one filename
  # per line (e.g., remote_nvim_spec.lua)
  # ============================================================================
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    outputs:
      test_matrix: ${{ steps.discover.outputs.test_matrix }}

    steps:
      - name: Initialize pacman keyring
        run: |
          pacman-key --init
          pacman-key --populate archlinux

      - name: Install system dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm git neovim base-devel python tar nodejs npm jq

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Discover test files
        id: discover
        run: |
          cd "$GITHUB_WORKSPACE/.config/nvim/tests"

          # Find all test files (plenary convention: *_spec.lua)
          echo "=== All test files ==="
          ls -1 *_spec.lua 2>/dev/null || echo "No test files found"

          # Check for blacklist file
          BLACKLIST_FILE=".testignore"
          TEST_ENTRIES=()

          # Function to convert filename to display name
          # e.g., "dap_spec.lua" -> "DAP Config"
          get_display_name() {
            local file="$1"
            # Extract the describe() block from the file for the display name
            local name=$(grep -m1 '^describe(' "$file" | sed 's/describe("\([^"]*\)".*/\1/' | sed "s/describe('\([^']*\)'.*/\1/")
            if [ -n "$name" ]; then
              echo "$name"
            else
              # Fallback: convert filename to title case
              echo "$file" | sed 's/_spec\.lua$//' | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g'
            fi
          }

          if [ -f "$BLACKLIST_FILE" ]; then
            echo ""
            echo "=== Blacklisted tests (from $BLACKLIST_FILE) ==="
            cat "$BLACKLIST_FILE"
            echo ""

            for test_file in *_spec.lua; do
              # Skip comments and empty lines in blacklist check
              if ! grep -qxF "$test_file" "$BLACKLIST_FILE"; then
                display_name=$(get_display_name "$test_file")
                TEST_ENTRIES+=("{\"file\":\"$test_file\",\"name\":\"$display_name\"}")
                echo "✓ Including: $test_file ($display_name)"
              else
                echo "✗ Excluding: $test_file"
              fi
            done
          else
            echo "No blacklist file found, including all tests"
            for test_file in *_spec.lua; do
              display_name=$(get_display_name "$test_file")
              TEST_ENTRIES+=("{\"file\":\"$test_file\",\"name\":\"$display_name\"}")
              echo "✓ Including: $test_file ($display_name)"
            done
          fi

          # Convert to JSON array for matrix
          JSON_ARRAY=$(printf '%s\n' "${TEST_ENTRIES[@]}" | jq -s -c '.')
          echo "test_matrix=$JSON_ARRAY" >> $GITHUB_OUTPUT

          echo ""
          echo "=== Test matrix JSON ==="
          echo "$JSON_ARRAY" | jq .

      - name: Install uv and Python providers
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"
          # Create venv and install pynvim (similar to local setup)
          uv venv ~/.local/share/venv
          uv pip install pynvim --python ~/.local/share/venv/bin/python
          # Verify pynvim is importable
          ~/.local/share/venv/bin/python -c "import pynvim; print('pynvim installed:', pynvim.__file__)"

      - name: Install test dependencies (plenary.nvim)
        run: |
          PLENARY_PATH="$HOME/.local/share/nvim/site/pack/vendor/start/plenary.nvim"
          mkdir -p "$(dirname "$PLENARY_PATH")"
          git clone --depth=1 https://github.com/nvim-lua/plenary.nvim "$PLENARY_PATH"

      - name: Setup Neovim config
        run: |
          mkdir -p ~/.config
          cp -r "$GITHUB_WORKSPACE/.config/nvim" ~/.config/

      - name: Install Neovim plugins with Lazy
        run: |
          # Create directories with correct permissions
          mkdir -p ~/.local/share/nvim/site/parser
          mkdir -p ~/.cache/nvim
          mkdir -p /tmp/nvim-treesitter
          chmod -R 755 ~/.local/share/nvim
          chmod -R 755 ~/.cache

          # Set TMPDIR to a writable location
          export TMPDIR=/tmp

          echo "Installing plugins with Lazy.nvim..."
          # First install, then restore to lock file versions for compatibility
          nvim --headless "+Lazy! install" +qa 2>&1 || true
          nvim --headless "+Lazy! restore" +qa 2>&1 || true

          # Verify textobjects plugin can load (needs configs.lua)
          if [ -f ~/.local/share/nvim/lazy/nvim-treesitter/lua/nvim-treesitter/configs.lua ]; then
            echo "✓ nvim-treesitter API compatible"
          else
            echo "⚠ nvim-treesitter new API - textobjects may not work"
          fi
          echo "Plugins installed successfully"

      - name: Install Treesitter parsers
        timeout-minutes: 5
        run: |
          # Set TMPDIR to a writable location
          export TMPDIR=/tmp

          # Only install parsers if not already present
          for parser in lua python; do
            if find ~/.local/share/nvim -name "${parser}.so" -path "*parser*" 2>/dev/null | grep -q .; then
              echo "✓ ${parser} parser already installed"
            else
              echo "Installing ${parser} parser..."
              nvim --headless -c "TSInstallSync! ${parser}" -c "qa!" || true
            fi
          done

          echo "=== Installed parsers ==="
          find ~/.local/share/nvim -name "*.so" -path "*parser*" 2>/dev/null | head -10 || echo "No parsers found"

      - name: Create setup artifact
        run: |
          # Ensure directories exist
          mkdir -p ~/.cache/nvim
          # Bundle nvim data, config, and venv (pynvim) for test jobs
          # Use --warning=no-file-changed to handle files modified during tar (treesitter compiling)
          tar --warning=no-file-changed -czf /tmp/nvim-setup.tar.gz \
            -C $HOME .local/share/nvim .local/share/venv .local/bin .config/nvim .cache/nvim || true
          ls -lh /tmp/nvim-setup.tar.gz

      - name: Upload setup artifact
        uses: actions/upload-artifact@v4
        with:
          name: nvim-setup
          path: /tmp/nvim-setup.tar.gz
          retention-days: 1

  # ============================================================================
  # TEST - Matrix jobs, each runs a different test file (parallel execution)
  # ============================================================================
  test:
    name: ${{ matrix.test.name }}
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: archlinux:latest
    strategy:
      fail-fast: false
      matrix:
        test: ${{ fromJson(needs.setup.outputs.test_matrix) }}

    steps:
      - name: Install minimal dependencies
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm neovim tar git python

      - name: Download setup artifact
        uses: actions/download-artifact@v4
        with:
          name: nvim-setup
          path: /tmp

      - name: Restore setup
        run: |
          tar -xzf /tmp/nvim-setup.tar.gz -C $HOME
          # Add venv to PATH so Neovim can find pynvim
          echo "$HOME/.local/share/venv/bin" >> $GITHUB_PATH
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "=== Restored nvim setup ==="
          ls -la ~/.config/nvim/
          ls -la ~/.local/share/nvim/lazy/ | head -10
          # Verify pynvim is available
          ~/.local/share/venv/bin/python -c "import pynvim; print('pynvim available')" || echo "pynvim not found"

      - name: Run test - ${{ matrix.test.name }}
        run: |
          cd ~/.config/nvim/tests
          echo "Running ${{ matrix.test.file }}..."
          nvim --headless \
            -u minimal_init.lua \
            -c "lua require('plenary.busted').run('${{ matrix.test.file }}')" \
            -c "qa!" \
            2>&1 | tee "/tmp/nvim_test_${{ matrix.test.file }}.log"

          # Check for failures
          failed_count=$(grep "Failed" "/tmp/nvim_test_${{ matrix.test.file }}.log" | sed 's/\x1b\[[0-9;]*m//g' | grep -oE '[0-9]+' | tail -1)
          error_count=$(grep "Errors" "/tmp/nvim_test_${{ matrix.test.file }}.log" | sed 's/\x1b\[[0-9;]*m//g' | grep -oE '[0-9]+' | tail -1)

          failed_count=${failed_count:-0}
          error_count=${error_count:-0}

          if [ "$failed_count" != "0" ] 2>/dev/null || [ "$error_count" != "0" ] 2>/dev/null; then
            echo "❌ Test failed (Failed: $failed_count, Errors: $error_count)"
            exit 1
          else
            echo "✅ Test passed"
          fi

      - name: Upload test logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.test.file }}
          path: /tmp/nvim_test_${{ matrix.test.file }}.log
          retention-days: 7

  # ============================================================================
  # LINT - Runs in parallel with setup
  # ============================================================================
  lint:
    name: Lua Syntax Check
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest

    steps:
      - name: Setup
        run: |
          pacman-key --init
          pacman-key --populate archlinux
          pacman -Syu --noconfirm
          pacman -S --noconfirm git lua luarocks gcc make

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run luacheck
        run: |
          luarocks install luacheck
          cd $GITHUB_WORKSPACE/.config/nvim
          luacheck lua/ init.lua --no-unused-args --no-unused-secondaries || true
        continue-on-error: true

  # ============================================================================
  # SUMMARY - Final status
  # ============================================================================
  summary:
    name: All Tests Complete
    runs-on: ubuntu-latest
    needs: [setup, test, lint]
    if: always()

    steps:
      - name: Summary
        run: |
          echo "# Neovim Configuration Tests Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.setup.result }}" == "success" ]; then
            echo "✅ **Setup**: Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Setup**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ **All tests**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Some tests**: Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.lint.result }}" == "success" ]; then
            echo "✅ **Lint check**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ **Lint check**: Issues found (non-blocking)" >> $GITHUB_STEP_SUMMARY
          fi

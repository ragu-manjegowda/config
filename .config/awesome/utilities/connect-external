#!/usr/bin/env bash

# Connect external monitor in extended mode
# Detects if monitor is already connected
# Configuration is read from config.lua via read-display-config

# Source the configuration from config.lua
source <("$HOME/.config/awesome/utilities/read-display-config")

echo "Checking for external monitor ($EXTERNAL_NAME)..."

if xrandr | grep -q "^${EXTERNAL_NAME} connected"; then
    echo "✓ External monitor detected"

    # Set up extended display
    "$HOME/.config/awesome/utilities/setup-monitors"

    # Wait for xrandr to finish
    sleep 2

    # Migrate clients to external monitor
    echo ""
    echo "Migrating windows to external monitor..."
    awesome-client "
local screen_mgr = require('module.screen-manager')
screen_mgr.migrate_to_external()
"

    # Wait for migration to complete
    sleep 2

    # Restart AwesomeWM to properly initialize new screen
    echo "Restarting AwesomeWM to initialize new screen..."
    awesome-client "awesome.restart()"

    echo "✓ Extended display configured"

    # Restart lid brightness manager service now that external monitor is connected
    echo ""
    echo "Restarting lid brightness manager..."
    systemctl --user restart lid-brightness-manager.service
    echo "✓ Lid brightness manager activated"
else
    echo "✗ No external monitor detected on $EXTERNAL_NAME"
    echo ""
    echo "Available displays:"
    xrandr | grep " connected"
fi


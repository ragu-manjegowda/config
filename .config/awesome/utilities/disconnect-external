#!/usr/bin/env bash

# Gracefully disconnect external monitor
# Moves windows to primary screen before disconnect
# Configuration is read from config.lua via read-display-config

# Source the configuration from config.lua
source <("$HOME/.config/awesome/utilities/read-display-config")

echo "Preparing for monitor disconnect..."

# Stop lid brightness manager since external monitor is being disconnected
echo "Stopping lid brightness manager..."
systemctl --user stop lid-brightness-manager.service

# Tell AwesomeWM to prepare
awesome-client "
local screen_mgr = require('module.screen-manager')
screen_mgr.prepare_for_disconnect()
"

# Give AwesomeWM time to reorganize
sleep 2

# Switch to laptop-only configuration
xrandr --output "$EXTERNAL_NAME" --off
xrandr --output "$PRIMARY_NAME" --primary --mode "$PRIMARY_MODE" --pos "$PRIMARY_POS"
xrandr --dpi "$DISPLAY_DPI"

echo "✓ External monitor disconnected"
echo "✓ Windows moved to $PRIMARY_NAME"
echo "✓ Lid brightness manager stopped (no external monitor)"
echo ""
echo "You can now safely unplug the external monitor"


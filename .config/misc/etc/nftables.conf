#!/usr/bin/nft -f
# vim:set ts=2 sw=2 et:

# Workstation firewall ruleset
# - Default-deny inbound, permissive outbound
# - SSH restricted to local subnet (192.168.1.0/24)
# - VPN (tun) interfaces fully allowed
# - mDNS/LLMNR for local service discovery
#
# Applied: 2026-02-15

destroy table inet filter
table inet filter {

  chain input {
    type filter hook input priority filter
    policy drop

    # --- Connection tracking ---
    ct state invalid drop comment "drop invalid packets"
    ct state { established, related } accept comment "allow tracked connections"

    # --- Loopback ---
    iif lo accept comment "allow all loopback traffic"

    # --- VPN tunnel interfaces ---
    iifname "tun*" accept comment "allow all traffic on VPN tun interfaces"

    # --- ICMP / ICMPv6 (essential for network health) ---
    ip protocol icmp accept comment "allow ICMPv4"
    meta l4proto ipv6-icmp accept comment "allow ICMPv6"

    # --- SSH (local subnet only) ---
    ip saddr 192.168.1.0/24 tcp dport 22 accept comment "allow SSH from local subnet"

    # --- mDNS (local link multicast, UDP 5353) ---
    udp dport 5353 accept comment "allow mDNS for local service discovery"

    # --- LLMNR (link-local name resolution, UDP/TCP 5355) ---
    udp dport 5355 accept comment "allow LLMNR UDP"
    tcp dport 5355 accept comment "allow LLMNR TCP"

    # --- Rate-limited reject for everything else (gives feedback to legit clients) ---
    pkttype host limit rate 5/second counter reject with icmpx type admin-prohibited
    counter comment "count dropped packets"
  }

  chain forward {
    type filter hook forward priority filter
    policy drop
  }
}
